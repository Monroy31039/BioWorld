"0","set.seed(123)"
"0","pi_values <- seq(0.01, 0.1, by = 0.01)"
"0","resultados <- list()"
"0","tablas_localidades_por_pi <- list()"
"0",""
"0","N <- nrow(calle_final_imputado)"
"0",""
"0","# Loop para cada pi"
"0","for (pi in pi_values) {"
"0","  # 1. Muestreo Bernoulli"
"0","  calle_simulada <- calle_final_imputado %>%"
"0","    mutate(muestra = as.integer(runif(n()) < pi)) %>%"
"0","    filter(muestra == 1)"
"0",""
"0","  # 2. Tama√±o total y por localidad"
"0","  n_total <- nrow(calle_simulada)"
"0","  nh_por_localidad <- calle_simulada %>%"
"0","    count(Localidad, name = ""nh"") %>%"
"0","    mutate(nh = if_else(nh == 1, 2L, nh)) "
"0",""
"0","  nh_barra <- mean(nh_por_localidad$nh)"
"0","  nh_min <- min(nh_por_localidad$nh)"
"0","  nh_max <- max(nh_por_localidad$nh)"
"0",""
"0","  # 3. Estimaciones por localidad"
"0","  estimaciones_por_localidad <- calle_simulada %>%"
"0","    group_by(Localidad) %>%"
"0","    summarise("
"0","      T_hat_h = sum(Edad) / pi,"
"0","      Var_hat_h = (1 / pi) * (1 / pi - 1) * sum(Edad^2),"
"0","      .groups = ""drop"""
"0","    ) %>%"
"0","    mutate(CV = sqrt(Var_hat_h) / T_hat_h)"
"0",""
"0","  # 4. Guardar tabla por localidad"
"0","  tabla_aux <- left_join(nh_por_localidad, estimaciones_por_localidad, by = ""Localidad"") %>%"
"0","    mutate(nh = if_else(nh == 1, 2L, nh)) %>%  "
"0","    select(Localidad, nh, CV) %>%"
"0","    arrange(desc(nh))"
"0",""
"0","  tablas_localidades_por_pi[[paste0(""pi_"", pi)]] <- tabla_aux"
"0",""
"0","  # 5. Estimaciones globales"
"0","  T_hat_total <- sum(estimaciones_por_localidad$T_hat_h)"
"0","  Var_hat_total <- sum(estimaciones_por_localidad$Var_hat_h)"
"0","  mu_hat <- T_hat_total / N"
"0","  Var_mu_hat <- Var_hat_total / N^2"
"0","  CV_global <- sqrt(Var_mu_hat) / mu_hat"
"0",""
"0","  CVh_barra <- mean(estimaciones_por_localidad$CV)"
"0","  CVh_min <- min(estimaciones_por_localidad$CV)"
"0","  CVh_max <- max(estimaciones_por_localidad$CV)"
"0",""
"0","  resultados[[as.character(pi)]] <- data.frame("
"0","    pi = pi,"
"0","    n = n_total,"
"0","    nh_barra = round(nh_barra, 2),"
"0","    nh_min = nh_min,"
"0","    nh_max = nh_max,"
"0","    CV = round(CV_global, 4),"
"0","    CVh_barra = round(CVh_barra, 4),"
"0","    CVh_min = round(CVh_min, 4),"
"0","    CVh_max = round(CVh_max, 4)"
"0","  )"
"0","}"
"0",""
"0","tabla_resultados <- bind_rows(resultados)"
"0",""
"0","print(tabla_resultados)"
