"0","varname <- ""Basuco""  "
"0","make_binary_tables <- function(varname, data, pi_values = seq(0.01,0.1,by=0.01), seed = 123) {"
"0","  set.seed(seed)"
"0","  N <- nrow(data)"
"0","  resumen_list   <- list()"
"0","  tabla_loc_pi05 <- NULL"
"0","  "
"0","  for (pi in pi_values) {"
"0","    df_sim <- data %>%"
"0","      mutate(muestra = as.integer(runif(n()) < pi)) %>%"
"0","      filter(muestra == 1) %>%"
"0","      mutate(y = as.integer(.data[[varname]] == ""Sí""))"
"0","    "
"0","    # Tamaños por localidad"
"0","    n_total <- nrow(df_sim)"
"0","    nh_loc  <- df_sim %>% count(Localidad, name = ""nh"")"
"0","    nh_bar  <- mean(nh_loc$nh)"
"0","    nh_min  <- min(nh_loc$nh)"
"0","    nh_max  <- max(nh_loc$nh)"
"0","    "
"0","    nh_min_present <- ifelse(nh_min == 1, 2, nh_min)"
"0","    "
"0","    # Estimaciones por localidad"
"0","    est_loc <- df_sim %>%"
"0","      group_by(Localidad) %>%"
"0","      summarise("
"0","        T_hat_h   = sum(y) / pi,"
"0","        Var_hat_h = (1/pi)*(1/pi - 1)*sum(y),"
"0","        .groups   = ""drop"""
"0","      ) %>%"
"0","      mutate("
"0","        CV_h = ifelse(T_hat_h > 0, sqrt(Var_hat_h) / T_hat_h, NA_real_)"
"0","      )"
"0","    "
"0","    if (abs(pi - 0.01) < 1e-8) {"
"0","      tabla_loc_pi05 <- est_loc %>%"
"0","        left_join(nh_loc, by = ""Localidad"") %>%"
"0","        mutate("
"0","          nh = ifelse(nh == 1, 2, nh),       "
"0","          CV_h = round(CV_h, 4)"
"0","        ) %>%"
"0","        select(Localidad, nh, CV_h) %>%"
"0","        arrange(desc(nh))"
"0","    }"
"0","    "
"0","    # Estimación global de proporción y CV"
"0","    T_tot   <- sum(est_loc$T_hat_h)"
"0","    V_tot   <- sum(est_loc$Var_hat_h)"
"0","    p_hat   <- T_tot / N"
"0","    Vp_hat  <- V_tot / N^2"
"0","    CV_glob <- sqrt(Vp_hat) / p_hat"
"0","    "
"0","    CVh_bar <- mean(est_loc$CV_h, na.rm = TRUE)"
"0","    CVh_min <- min(est_loc$CV_h, na.rm = TRUE)"
"0","    CVh_max <- max(est_loc$CV_h, na.rm = TRUE)"
"0",""
"0","    resumen_list[[as.character(pi)]] <- data.frame("
"0","      variable  = varname,"
"0","      pi        = pi,"
"0","      n         = n_total,"
"0","      nh_barra  = round(nh_bar, 2),"
"0","      nh_min    = nh_min_present,       "
"0","      nh_max    = nh_max,"
"0","      CV        = round(CV_glob, 4),"
"0","      CVh_barra = round(CVh_bar, 4),"
"0","      CVh_min   = round(CVh_min, 4),"
"0","      CVh_max   = round(CVh_max, 4)"
"0","    )"
"0","  }"
"0","  "
"0","  resumen <- bind_rows(resumen_list)"
"0","  list(resumen   = resumen,"
"0","       localidad = tabla_loc_pi05)"
"0","}"
"0",""
"0","res <- make_binary_tables(varname, calle_final_imputado)"
"0",""
"0","print(res$resumen)"
